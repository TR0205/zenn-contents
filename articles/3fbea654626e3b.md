---
title: "Laravel Envoyã‚’åˆ©ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

# æ¦‚è¦

é–‹ç™ºç’°å¢ƒã®ã‚µãƒ¼ãƒãƒ¼ã¸ Laravel Envoy ã‚’åˆ©ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
.gitlab-ci.yml ã‚’åˆ©ç”¨ã—ãŸç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤

# ç’°å¢ƒ

Laravel Framework 10.7.1

# æ‰‹é †

## åˆ©ç”¨ã•ã›ã¦ã„ãŸã ã„ãŸ Docker ç’°å¢ƒ

https://github.com/ucan-lab/docker-laravel
ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

## Envoy ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
composer require laravel/envoy --dev
```

## Envoy ã®ãƒ†ã‚¹ãƒˆ

ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ã® Docker ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ

- Laravel ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(app ã¨ã‹ bootstrap ç­‰ãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª)ã« Envoy.blade.php ã‚’ä½œæˆ
- @servers ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã‚’è¨˜è¼‰ã™ã‚‹ã€‚ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆãªã®ã§'localhost' => '127.0.0.1'ã§è©¦ã™
- list ãŒ task ã®åå‰ã§ã€å®Ÿè¡Œã™ã‚‹éš›ã«æŒ‡å®šã™ã‚‹

```php:Envoy.blade.php
@servers(['localhost' => '127.0.0.1'])

@task('list', ['on' => 'localhost'])
    ls -l
@endtask

```

ä»¥ä¸‹ã‚’å®Ÿè¡Œ

```
php vendor/bin/envoy run list
```

çµæœ

```
/workspace# php vendor/bin/envoy run list
[127.0.0.1]: total 350
[127.0.0.1]: drwxrwxrwx 1 root root   4096 May 17 11:09 app
[127.0.0.1]: -rwxr-xr-x 1 root root   1686 Apr 14 23:03 artisan
[127.0.0.1]: drwxrwxrwx 1 root root      0 Apr 14 23:03 bootstrap
[127.0.0.1]: -rwxr-xr-x 1 root root   1885 May 17 11:12 composer.json
[127.0.0.1]: -rwxr-xr-x 1 root root 288876 May 17 11:12 composer.lock
[127.0.0.1]: drwxrwxrwx 1 root root   4096 May 17 11:09 config
[127.0.0.1]: drwxrwxrwx 1 root root   4096 Apr 14 23:03 database
[127.0.0.1]: -rwxr-xr-x 1 root root    193 May 17 13:37 Envoy.blade.php
[127.0.0.1]: drwxrwxrwx 1 root root  32768 May 12 17:32 node_modules
[127.0.0.1]: -rwxr-xr-x 1 root root    226 May 17 11:09 package.json
[127.0.0.1]: -rwxr-xr-x 1 root root   1142 Apr 14 23:03 phpunit.xml
[127.0.0.1]: drwxrwxrwx 1 root root   4096 May 15 13:36 public
[127.0.0.1]: -rwxr-xr-x 1 root root   4158 Apr 14 23:03 README.md
[127.0.0.1]: drwxrwxrwx 1 root root      0 May 17 11:09 resources
[127.0.0.1]: drwxrwxrwx 1 root root      0 May 17 11:09 routes
[127.0.0.1]: drwxrwxrwx 1 root root      0 May  9 13:40 storage
[127.0.0.1]: drwxrwxrwx 1 root root      0 May 17 11:09 tests
[127.0.0.1]: drwxrwxrwx 1 root root   8192 May 17 11:12 vendor
[127.0.0.1]: -rwxr-xr-x 1 root root    263 May 17 11:09 vite.config.js
```

Envoy.blade.php ã§å®šç¾©ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹
Envoy ãŒå‹•ãã“ã¨ã¯ç¢ºèªã§ããŸ

## ãƒ‡ãƒ—ãƒ­ã‚¤

### ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚¼ãƒ­ã®å°å…¥

ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§èª°ã‹ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦ã„ã¦ã‚‚ã„ã„ã‚ˆã†ã«è¨­å®šã™ã‚‹

ä¾‹ï¼š

```php:Envoy.blade.php
@setup
    $repository = 'git@gitlab.example.com:<USERNAME>/laravel-sample.git';
    $releases_dir = '/var/www/app/releases';
    $app_dir = '/var/www/app';
    $release = date('YmdHis');
    $new_release_dir = $releases_dir .'/'. $release;
@endsetup
```

$repositoryï¼šgit remote -vã§ç¢ºèªã§ãã‚‹
$releases_dirï¼šãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
$app_dirï¼šå®Ÿéš›ã«ã‚¢ãƒ—ãƒªãŒç¨¼åƒã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

### @story ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–

deploy ã‚¿ã‚¹ã‚¯ã‚’åˆ†å‰²ã—ã€ãã®ä¸­ã§è¤‡æ•°ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```php:Envoy.blade.php
@story('deploy')
    clone_repository
    run_composer
    update_symlinks
@endstory
```

### ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

```php:Envoy.blade.php
@task('clone_repository')
    echo 'Cloning repository'
    [ -d {{ $releases_dir }} ] || mkdir {{ $releases_dir }}
    git clone --depth 1 {{ $repository }} {{ $new_release_dir }}
    cd {{ $new_release_dir }}
    git reset --hard {{ $commit }}
@endtask
```

- é€šå¸¸ã® git clone ã§ã¯ã™ã¹ã¦ã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—ã™ã‚‹ãŒã€--depth 1 ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã®ã¿ã‚’å–å¾—ã™ã‚‹

### copmposer install

```php:Envoy.blade.php
@task('run_composer')
    echo "Starting deployment ({{ $release }})"
    cd {{ $new_release_dir }}
    composer install --prefer-dist --no-scripts -q -o
@endtask
```

### æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–

```php:Envoy.blade.php
@task('update_symlinks')
    echo "Linking storage directory"
    rm -rf {{ $new_release_dir }}/storage
    ln -nfs {{ $app_dir }}/storage {{ $new_release_dir }}/storage

    echo 'Linking .env file'
    ln -nfs {{ $app_dir }}/.env {{ $new_release_dir }}/.env

    echo 'Linking current release'
    ln -nfs {{ $new_release_dir }} {{ $app_dir }}/current
@endtask
```

# å‚è€ƒ

https://docs.gitlab.com/ee/ci/examples/laravel_with_gitlab_and_envoy/
